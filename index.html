<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HDS Tokens</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    /* Top-level tabs for each file */
    .file-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .small {
        font-size: 13px;
        font-weight: 500;
        line-height: 20px;
        display: inline-block;
    }

    .medium {
        font-size: 14px;
        font-weight: 500;
        line-height: 20px;
        display: inline-block;
    }

    .file-tab {
      padding: 8px 16px;
      cursor: pointer;
      border: 1px solid #ddd;
      background-color: #eee;
    }
    .file-tab.active {
      background-color: #ccc;
    }

    /* Each file's content container */
    .file-content {
      display: none; /* hidden by default */
    }
    .file-content.active {
      display: block;
    }

    /* Buttons to toggle table vs JSON */
    .view-toggle-btn {
      padding: 5px 10px;
      margin-right: 10px;
      cursor: pointer;
      border: 1px solid #ddd;
      background-color: #eee;
    }
    .view-toggle-btn.active {
      background-color: #ccc;
    }

    .copy-btn {
      float: right;
      padding: 5px 10px;
      cursor: pointer;
      border: none;
      background: #007bff;
      color: white;
    }

    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
        border: 1px solid #ddd;
    padding: 8px;
    height: 20px;
    text-align: left;
    vertical-align: middle;
    width: 33%;
    }
    th {
      background-color: #f2f2f2;
    }

    .color-circle {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: inline-block;
      border: 1px solid #0000001c;
      margin-right: 5px;
      line-height: 20px;
    }

    .middle-flex {
        display: flex;
        align-items: center;
    }

    /* table-view and json-view containers */
    .table-view {
      display: block;
    }
    .table-view.hidden {
      display: none;
    }
    .json-view {
      display: none;
      border: 1px solid #ddd;
      background-color: #fafafa;
      padding: 10px;
      white-space: pre;
    }
    .json-view.active {
      display: block;
    }
  </style>
  <script>
    /* ================================
       ALIAS RESOLUTION & COLOR CHECK
       ================================ */
    function isValidColor(str) {
      const s = new Option().style;
      s.color = str;
      return s.color !== '';
    }

    function singleResolve(alias, tokenData) {
      const patterns = {
        'global-color': 'output_json/primitives.json',
        'light': 'output_json/light.json',
        'dark': 'output_json/dark.json'
      };
      const match = alias.match(/^{(global-color|light|dark)\.([^}]+)}$/);
      if (!match) return alias;

      const filePrefix = match[1];
      const pathParts = match[2].split('.');
      let refData = tokenData[patterns[filePrefix]];

      if (filePrefix === 'global-color' && refData['global-color']) {
        refData = refData['global-color'];
      }
      for (const part of pathParts) {
        if (refData && typeof refData === 'object' && part in refData) {
          refData = refData[part];
        } else {
          return alias;
        }
      }
      return refData?.value ?? refData ?? alias;
    }

    function fullyResolve(value, tokenData) {
      for (let i = 0; i < 10; i++) {
        if (typeof value !== 'string') break;
        const next = singleResolve(value, tokenData);
        if (next === value) break;
        value = next;
      }
      return value;
    }

    /* ================================
       BUILD NESTED TABLE
       ================================ */

    // Returns an object: { foundValue: boolean, html: string }
    // foundValue => did we find any .value tokens in this subtree?
    function buildNestedTable(obj, tokenData, prefix, isPrimitives) {
      let rowsHtml = '';
      let foundAnyRow = false; // track if we found a .value at all

      for (const key in obj) {
        const val = obj[key];
        const currentName = prefix ? prefix + '.' + key : key;

        // If it's a nested object with no .value => subtable
        if (typeof val === 'object' && !val?.value) {
          const nested = buildNestedTable(val, tokenData, currentName, isPrimitives);
          if (nested.foundValue) {
            // only add a row if there's something in there
            foundAnyRow = true;
            const colSpan = isPrimitives ? 2 : 3;
            rowsHtml += `
              <tr>
                <td colspan="${colSpan}">
                  <span class="small">${currentName}</span>
                  ${nested.html}
                </td>
              </tr>
            `;
          }
        }
        else if (val && val.value) {
          foundAnyRow = true;
          const rawValue = val.value;
          const resolved = isPrimitives ? rawValue : fullyResolve(rawValue, tokenData);

          const looksHex = typeof resolved === 'string' && resolved.startsWith('#');
          const isColorType = val.type === 'color';
          const recognized = (typeof resolved === 'string' && isValidColor(resolved));

          let colorCell = resolved;
          if ((looksHex || isColorType || recognized) && typeof resolved === 'string') {
            colorCell = `<div class="middle-flex"><span class="color-circle" style="background-color: ${resolved};"></span><span class="medium">${resolved}</span></div>`;
          }

          if (isPrimitives) {
            // 2 columns
            rowsHtml += `
              <tr>
                <td><span class="medium">${currentName}</span></td>
                <td>${colorCell}</td>
              </tr>
            `;
          } else {
            // 3 columns: name, alias, resolved
            rowsHtml += `
              <tr>
                 <td><span class="medium">${currentName}</span></td>
                <td><span class="medium">${rawValue}</span></td>
                <td><span class="medium">${colorCell}</span></td>
              </tr>
            `;
          }
        }
      }

      // No .value => no table
      if (!foundAnyRow) {
        return {
          foundValue: false,
          html: ''
        };
      }

      // We found at least one row => wrap with table
      let tableHeader = '';
      if (isPrimitives) {
        tableHeader = `
          <table>
            
        `;
      } else {
        tableHeader = `
          <table>
            
        `;
      }
      const finalHtml = `${tableHeader}${rowsHtml}</table>`;
      return {
        foundValue: true,
        html: finalHtml
      };
    }

    /* ================================
       MAIN SCRIPT
       ================================ */
    async function loadTokens() {
      const files = [
        'output_json/primitives.json',
        'output_json/semantics.json',
        'output_json/light.json',
        'output_json/dark.json'
      ];

      // Load data
      const tokenData = {};
      for (const file of files) {
        try {
          const response = await fetch(file);
          if (!response.ok) throw new Error(`Failed to load ${file}`);
          tokenData[file] = await response.json();
        } catch(e) {
          console.error(e);
        }
      }

      const fileTabs = document.getElementById('file-tabs');
      const fileContents = document.getElementById('file-contents');

      const nameMap = {
        'output_json/primitives.json': 'PRIMITIVES',
        'output_json/semantics.json': 'SEMANTICS',
        'output_json/light.json': 'LIGHT',
        'output_json/dark.json': 'DARK'
      };

      for (const filePath of files) {
        const fileName = nameMap[filePath];
        const isPrimitives = filePath.includes('primitives');
        const data = tokenData[filePath] || {};

        // Build the nested table
        const { foundValue, html } = buildNestedTable(data, tokenData, '', isPrimitives);
        // raw JSON
        const rawJSON = JSON.stringify(data, null, 2);

        // Create tab button
        const tabBtn = document.createElement('button');
        tabBtn.className = 'file-tab';
        tabBtn.textContent = fileName;
        tabBtn.onclick = () => activateFileTab(fileName);
        fileTabs.appendChild(tabBtn);

        // Create content container
        const contentDiv = document.createElement('div');
        contentDiv.className = 'file-content';
        contentDiv.id = `file-content-${fileName}`;

        // If no tokens => show a message, else show the table
        let tableHtml = foundValue ? html : `<p>No tokens with .value found here.</p>`;

        contentDiv.innerHTML = `
          <div>
            <button class="view-toggle-btn active" onclick="showTable('${fileName}')">Show Table</button>
            <button class="view-toggle-btn" onclick="showJSON('${fileName}')">Show Raw JSON</button>
            <button class="copy-btn" onclick="copyJSON('${fileName}')">Copy JSON</button>
          </div>
          <div id="table-${fileName}" class="table-view">
            ${tableHtml}
          </div>
          <pre id="json-${fileName}" class="json-view">${rawJSON}</pre>
        `;

        fileContents.appendChild(contentDiv);
      }

      // Show the first tab by default
      if (files.length > 0) {
        const firstName = nameMap[files[0]];
        activateFileTab(firstName);
      }
    }

    function activateFileTab(tabName) {
      document.querySelectorAll('.file-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.file-content').forEach(fc => {
        fc.classList.remove('active');
      });

      const tabBtn = Array.from(document.querySelectorAll('.file-tab'))
        .find(b => b.textContent === tabName);
      if (tabBtn) tabBtn.classList.add('active');

      const contentDiv = document.getElementById(`file-content-${tabName}`);
      if (contentDiv) contentDiv.classList.add('active');

      // Show table by default
      showTable(tabName);
    }

    function showTable(tabName) {
      const parent = document.getElementById(`file-content-${tabName}`);
      if (!parent) return;

      const tableDiv = parent.querySelector('.table-view');
      const jsonDiv  = parent.querySelector('.json-view');

      // Mark sub-buttons
      parent.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
      const tableBtn = Array.from(parent.querySelectorAll('.view-toggle-btn'))
        .find(b => b.textContent.includes('Table'));
      if (tableBtn) tableBtn.classList.add('active');

      if (tableDiv) {
        tableDiv.classList.remove('hidden');
        tableDiv.style.display = 'block';
      }
      if (jsonDiv) {
        jsonDiv.classList.remove('active');
        jsonDiv.style.display = 'none';
      }
    }

    function showJSON(tabName) {
      const parent = document.getElementById(`file-content-${tabName}`);
      if (!parent) return;
      const tableDiv = parent.querySelector('.table-view');
      const jsonDiv  = parent.querySelector('.json-view');

      parent.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
      const jsonBtn = Array.from(parent.querySelectorAll('.view-toggle-btn'))
        .find(b => b.textContent.includes('Raw JSON'));
      if (jsonBtn) jsonBtn.classList.add('active');

      if (tableDiv) {
        tableDiv.classList.add('hidden');
        tableDiv.style.display = 'none';
      }
      if (jsonDiv) {
        jsonDiv.classList.add('active');
        jsonDiv.style.display = 'block';
      }
    }

    function copyJSON(tabName) {
      const parent = document.getElementById(`file-content-${tabName}`);
      if (!parent) return;

      const jsonEl = parent.querySelector('.json-view');
      if (!jsonEl) return;

      const content = jsonEl.textContent;
      navigator.clipboard.writeText(content).then(() => {
        alert('JSON copied to clipboard!');
      });
    }

    document.addEventListener('DOMContentLoaded', loadTokens);
  </script>
</head>
<body>
  <h1>Token List (Skip Thead if No Values)</h1>
  <div class="file-tabs" id="file-tabs"></div>
  <div id="file-contents"></div>
</body>
</html>
